<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>密码生成器</title>
<style>
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    display: flex; justify-content: center; align-items: center;
    height: 100vh; margin: 0;
    background: linear-gradient(135deg,#6e8efb,#a777e3); color: #333;
}
.container {
    text-align: center; padding: 30px; background: #fff;
    border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    width: 420px; max-width: 95%;
}
h2 { color: #2c3e50; margin-bottom: 25px; }
.input-group {
    display: flex; justify-content: center; align-items: center;
    gap: 8px; margin: 20px 0;
}
input {
    padding: 10px; width: 3em; border: 2px solid #ddd; border-radius: 6px;
    font-size: 16px; text-align: center; transition: border-color .3s;
}
input:focus { border-color: #6e8efb; outline: none; }
button {
    padding: 10px 14px; border: none; border-radius: 6px;
    font-size: 15px; cursor: pointer; color: #fff; transition: background-color .3s;
}
#generateButton { background: #3498db; }
#generateButton:hover { background: #2980b9; }
#clearButton { background: #e74c3c; }
#clearButton:hover { background: #c0392b; }
#copyButton { background: #2ecc71; margin-left: 10px; }
#copyButton:hover { background: #27ae60; }
#copyButton:disabled { background: #95a5a6; cursor: not-allowed; }
.password-container {
    display: flex; align-items: center; justify-content: center; margin: 20px 0;
}
#passwordOutput {
    flex-grow: 1; text-align: center; min-height: 20px;
    margin: 0; padding: 15px; border-radius: 6px;
    border: 1px solid #e9ecef; background: #f8f9fa;
    font: bold 18px 'Courier New', monospace; color: #2c3e50;
}
.message {
    margin: 15px 0; padding: 10px;
    border-radius: 4px; font-weight: 500; display: none;
}
.error { background: #ffecec; color: #e74c3c; border: 1px solid #f5b7b1; }
.success { background: #eafaf1; color: #27ae60; border: 1px solid #a3e4d7; }
</style>
</head>
<body>
<div class="container">
    <h2>🔐 密码生成器</h2>
    <div class="input-group">
        <input id="inputChars" type="text" maxlength="3" placeholder="3位"
               oninput="this.value=this.value.replace(/[^a-zA-Z0-9]/g,''); if(this.value.length===3) generatePassword();">
        <button id="generateButton" onclick="generatePassword()">生成</button>
        <button id="clearButton" onclick="clearInput()">清除</button>
    </div>
    <div class="password-container">
        <div id="passwordOutput"></div>
        <button id="copyButton" onclick="copyPassword()" disabled>复制</button>
    </div>
    <div id="errorMessage" class="message error"></div>
    <div id="successMessage" class="message success"></div>
</div>

<script>
const charset = {
    letters: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz',
    digits: '0123456789',
    symbols: '?!:<>=&,._-/+*'
};
const $ = id => document.getElementById(id);
const inputEl = $('inputChars'), outputEl = $('passwordOutput');
const errorEl = $('errorMessage'), successEl = $('successMessage');
const copyBtn = $('copyButton');

const showMsg = (el, text) => {
    [errorEl, successEl].forEach(e => e.style.display='none');
    if (text) { el.textContent=text; el.style.display='block'; }
};

// --- START: NEW SHA-256 AND PASSWORD GENERATION LOGIC ---

/**
 * 使用 Web Crypto API 计算输入字符串的 SHA-256 哈希值（返回十六进制字符串）。
 * @param {string} str - 待哈希的输入字符串 (3位字符)。
 * @returns {Promise<string>} - SHA-256 哈希值（64位十六进制字符串）。
 */
async function sha256(str) {
    const encoder = new TextEncoder();
    const data = encoder.encode(str);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    // 转换为十六进制字符串
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

/**
 * 从 SHA-256 哈希值中确定性地选取和排列字符，替代伪随机数生成器。
 * @param {string} hash - SHA-256 哈希值（64位十六进制字符串）。
 * @returns {string} - 生成的10位密码。
 */
function generateFromHash(hash) {
    // 密码构成: 4字母 + 4数字 + 2符号 = 10位
    const charCounts = [
        { pool: charset.letters, count: 4 },
        { pool: charset.digits, count: 4 },
        { pool: charset.symbols, count: 2 }
    ];

    let password = [];
    let hashIndex = 0;

    // 1. 确定性选取字符
    for (const { pool, count } of charCounts) {
        for (let i = 0; i < count; i++) {
            // 从哈希值中提取下一个字节（两个十六进制字符）
            const hex = hash.substring(hashIndex, hashIndex + 2);
            // 转换为数字，并模池长度，得到字符索引
            const val = parseInt(hex, 16);
            const index = val % pool.length;
            password.push(pool[index]);

            // 移动到哈希的下一个字节，循环使用哈希值（SHA-256有32字节/64十六进制字符）
            hashIndex = (hashIndex + 2) % hash.length;
        }
    }

    // 2. 确定性打乱顺序 (基于哈希值进行Fisher-Yates洗牌)
    // 从哈希中获取一个新的起点进行混淆
    hashIndex = 0;
    for (let i = password.length - 1; i > 0; i--) {
        const hex = hash.substring(hashIndex, hashIndex + 2);
        const val = parseInt(hex, 16);
        
        // 生成一个位于 [0, i] 区间的确定性索引
        const j = val % (i + 1);
        
        // 交换
        [password[i], password[j]] = [password[j], password[i]];
        
        // 移动到哈希的下一个字节
        hashIndex = (hashIndex + 2) % hash.length;
    }

    return password.join('');
}


async function generatePassword() {
    const val = inputEl.value;
    if (!/^[a-zA-Z0-9]{3}$/.test(val)) {
        showMsg(errorEl,'请输入正好3个字母或数字！');
        outputEl.textContent=''; copyBtn.disabled=true; 
        return;
    }

    // 取消输入框焦点
    inputEl.blur();

    try {
        // 1. 生成 SHA-256 哈希值作为确定性种子
        const hash = await sha256(val);
        
        // 2. 根据哈希值生成密码
        const pwd = generateFromHash(hash);

        outputEl.textContent = pwd;
        copyBtn.disabled = false;

        // 自动复制密码
        copyPassword();
    } catch(e) {
        console.error("密码生成失败:", e);
        showMsg(errorEl, '密码生成失败，请检查浏览器支持。');
        outputEl.textContent=''; copyBtn.disabled=true;
    }
}

// --- END: NEW SHA-256 AND PASSWORD GENERATION LOGIC ---

function copyPassword() {
    const txt=outputEl.textContent;
    if(!txt) return showMsg(errorEl,'没有密码可复制！');
    const done=()=>{showMsg(successEl,'密码已生成并复制到剪贴板！'); setTimeout(()=>successEl.style.display='none',3000);};
    // 使用 Web Crypto API 的复制是异步的，原函数需改为异步或保持同步处理
    if(navigator.clipboard?.writeText){navigator.clipboard.writeText(txt).then(done).catch(()=>fallbackCopy(txt,done));}
    else fallbackCopy(txt,done);
}

function fallbackCopy(txt,done){
    const ta=document.createElement("textarea");
    ta.value=txt; ta.style.position="fixed"; ta.style.left="-9999px"; document.body.appendChild(ta);
    ta.select(); try{ if(document.execCommand('copy')) done(); else throw 0; }
    catch{ showMsg(errorEl,'复制失败，请手动选择密码并复制'); }
    document.body.removeChild(ta);
}

function clearInput(){
    inputEl.value=''; outputEl.textContent=''; copyBtn.disabled=true;
    [errorEl,successEl].forEach(e=>e.style.display='none');
    inputEl.focus();
}

// 页面加载时自动聚焦输入框
window.onload = () => inputEl.focus();
</script>
</body>
</html>
